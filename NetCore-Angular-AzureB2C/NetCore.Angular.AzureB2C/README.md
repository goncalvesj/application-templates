# Template project with .NET Core 3, AAD and Angular 8

This template is adapted to the Angular Template that is generated by default in Visual Studio.

The Angular application uses ```@azure/msal-angular``` **(to use this library with Angular 8 the ``rxjs-compat`` library is required)** to handle authentication with B2C and gets access tokens automatically to call the API endpoints.

Before the application is completely initialized a request is made a ***Configuration Endpoint*** to get all the B2C details like domains and policies.

## How it works

Angular 8 application is generated in ***ClientApp*** folder.

Run ```ng serve``` in ClientApp folder. Start Visual Studio.

In ``app.module`` an HTTP request is made to the Configuration Endpoint, populates the ``MsalConfig`` object that is used in the ``MsalModule``.

``MsalGuard`` and ``MsalInterceptor`` are also configured in ``app.module``.

```Typescript
export function getConfig() {
  const baseUrl = window.location.protocol + '//' + window.location.host;

  const request = new XMLHttpRequest();
  request.open('GET', baseUrl + configurationEndpoint, false); // request application settings synchronous
  request.send(null);
  const response = JSON.parse(request.responseText);

  const protectedResourceMap: [string, string[]][] = [
    [baseUrl, [response.clientId]]
  ];

  const msalConfig: MsalConfig = {
    clientID: response.clientId,
    authority: response.authority,
    validateAuthority: false,
    cacheLocation: 'localStorage',
    navigateToLoginRequestUrl: false,
    popUp: false,
    consentScopes: response.scope,
    protectedResourceMap,
    correlationId: '1234',
    // level: LogLevel.Verbose,
    piiLoggingEnabled: true
  };

  return msalConfig;
}
```

## B2C information in .NET Application settings

```JSON
  "AzureAdB2C": {
    "Instance": "https://v1joaogoncalvesb2c.b2clogin.com/tfp/",
    "ClientId": "90f86bd4-cdb6-4098-bf69-541ebb77d3ce",
    "Domain": "v1joaogoncalvesb2c.onmicrosoft.com",
    "SignUpSignInPolicyId": "B2C_1_SignUpOrSignIn",
    "Scope": [ "90f86bd4-cdb6-4098-bf69-541ebb77d3ce" ]
  }
```

### B2C object is configured in ``Startup.cs``

```C#
services.AddOptions<SettingsDto>()
.Configure<IConfiguration>((options, configuration) => configuration.GetSection(StaticData.AzureAdB2C).Bind(options));
```

### And then is retrieved by calling the Configuration controller

```C#
[ApiController]
[Route("[controller]")]
public class ConfigController : ControllerBase
{
  private readonly ILogger<ConfigController> _logger;

  private readonly SettingsDto _settingsDto;

  public ConfigController(ILogger<ConfigController> logger, IOptions<SettingsDto> settingsDto)
  {
    _logger = logger;
    _settingsDto = settingsDto.Value;
  }

  [HttpGet]
  public IActionResult Get()
  {
    return Ok(_settingsDto);
  }
}
```
